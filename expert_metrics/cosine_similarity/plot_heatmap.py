

import matplotlib.pyplot as plt
import numpy as np
from matplotlib.backends.backend_pdf import PdfPages
import matplotlib.ticker as ticker
import math

cmap_colors = {
    'frequency': 'Reds',
    'hessian_trace': 'Blues',
    'Cosine Similarity': 'Greens',
}

def plot_metric_heatmap_deepseek(layer_dict, fig_title, heatmap_title, filename, metric_type):
    num_layers = len(layer_dict)
    num_sublayers = len(next(iter(layer_dict.values())))
    data = np.zeros((num_sublayers, num_layers))
    print("num_layers", num_layers)

    for layer_idx, sublayer_dict in layer_dict.items():
        for sublayer_idx, value in sublayer_dict.items():
            data[int(sublayer_idx), int(layer_idx)] = value

    with PdfPages(filename) as pdf:
        plt.rcParams['font.family'] = 'serif'
        fig, ax = plt.subplots(figsize=(8, 5))
        im = ax.imshow(data, cmap=cmap_colors[metric_type], aspect="auto")  

        title_fontsize = 32
        label_fontsize = 32
        tick_fontsize = 32

        ax.set_title(fig_title, fontsize=title_fontsize)
        ax.set_xlabel("Layer Index", fontsize=label_fontsize)
        ax.set_ylabel("Expert Index", fontsize=label_fontsize)

        if num_layers < 10:
            layer_steps = 2
        elif num_layers < 20:
            layer_steps = 3
        elif num_layers < 30:
            layer_steps = 4
        else:
            layer_steps = 5
        
        ax.set_xticks(np.arange(0, num_layers-1, layer_steps)) 
        ax.set_yticks(np.arange(0, num_sublayers, 10))
        ax.set_xticklabels(np.arange(1, num_layers, layer_steps), fontsize=tick_fontsize)
        ax.set_yticklabels(np.arange(0, num_sublayers, 10), fontsize=tick_fontsize)

        raw_vmin = np.min(data)
        raw_vmax = np.max(data)
        raw_vmid = (raw_vmin + raw_vmax) / 2
        
        # cbar = fig.colorbar(im, ax=ax, label=heatmap_title, fraction=0.046, pad=0.015)
        cbar = fig.colorbar(im, ax=ax, label=heatmap_title)
        if metric_type == "frequency" or metric_type == "hessian_trace":
            # make vmin and vmax to be nearest to 5K
            vmin = round(raw_vmin/5000) * 5000
            vmax = math.floor(raw_vmax/5000) * 5000
            vmid = round(raw_vmid/5000) * 5000
            if vmid == vmax:
                vmid = math.floor(raw_vmid/5000) * 5000
            if metric_type == "hessian_trace":
                print("model_name", fig_title, "vmin", vmin, "vmid", vmid, "vmax", vmax)
            cbar.set_ticks([vmin, vmid, vmax])
        else:
            cbar.set_ticks([0, raw_vmid, raw_vmax])
        cbar.ax.tick_params(labelsize=tick_fontsize)
        # Define a function to format the tick labels
        def format_func(value, _):
            if value == 0:
                return '0'
            elif value >= 1_000_000:  # For millions
                return f'{int(round(value) / 1_000_000)}M'
            elif value >= 1_000:  # For thousands
                return f'{int(round(value) / 1_000)}K'
                
            else:
                return str(int(value))  # For smaller values
        
        def format_float(value, _):
            if value == 0:
                return '0'
            else:
                return f'{value:.1f}'
            
        if metric_type == "frequency":
            # Set the formatter for the colorbar ticks
            cbar.ax.yaxis.set_major_formatter(ticker.FuncFormatter(format_func))
            cbar.set_label('Frequency', size=tick_fontsize)
        elif metric_type == "hessian_trace":
            cbar.ax.yaxis.set_major_formatter(ticker.FuncFormatter(format_func)) 
            cbar.set_label('', size=tick_fontsize)
        elif metric_type == "combined": 
            cbar.ax.yaxis.set_major_formatter(ticker.FuncFormatter(format_float))
            cbar.set_label('', size=tick_fontsize)

        plt.setp(ax.get_xticklabels(), rotation=0, ha="center", rotation_mode="anchor")

        fig.tight_layout()

        pdf.savefig(fig)

        plt.close(fig)

if __name__ == '__main__':
    layer_dict = {
        
        # '0': {'0': 4, '1': 2, '2': 2, '3': 2, '4': 2, '5': 2, '6': 2, '7': 4, '8': 2, '9': 4, '10': 4, '11': 8, '12': 4, '13': 2,
        #                  '14': 2, '15': 4, '16': 2, '17': 2, '18': 4, '19': 4, '20': 4, '21': 4, '22': 2, '23': 4, '24': 2, '25': 2, '26': 2,
        #                    '27': 2, '28': 4, '29': 4, '30': 2, '31': 2, '32': 2, '33': 2, '34': 8, '35': 2, '36': 2, '37': 2, '38': 2, '39': 4,
        #                      '40': 4, '41': 4, '42': 8, '43': 4, '44': 2, '45': 2, '46': 2, '47': 2, '48': 2, '49': 2, '50': 2, '51': 2, '52': 2, 
        #                      '53': 4, '54': 2, '55': 2, '56': 2, '57': 2, '58': 4, '59': 2, '60': 2, '61': 2, '62': 2, '63': 2}, 
                             
                             '1': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 2, '5': 8, '6': 4, '7': 2, '8': 2, '9': 2, '10': 2, '11': 2, '12': 2, '13': 4, '14': 8, '15': 8, '16': 2, '17': 2, '18': 4, '19': 2, '20': 4, '21': 4, '22': 2, '23': 2, '24': 2, '25': 4, '26': 4, '27': 2, '28': 2, '29': 2, '30': 2, '31': 2, '32': 2, '33': 8, '34': 2, '35': 4, '36': 2, '37': 2, '38': 8, '39': 2, '40': 2, '41': 2, '42': 2, '43': 2, '44': 2, '45': 2, '46': 2, '47': 2, '48': 2, '49': 2, '50': 2, '51': 4, '52': 4, '53': 2, '54': 2, '55': 8, '56': 4, '57': 2, '58': 2, '59': 2, '60': 4, '61': 2, '62': 4, '63': 4}, 
                             '2': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 2, '5': 4, '6': 2, '7': 4, '8': 2, '9': 4, '10': 2, '11': 2, '12': 4, '13': 2, '14': 2, '15': 2, '16': 8, '17': 2, '18': 2, '19': 2, '20': 2, '21': 2, '22': 2, '23': 2, '24': 2, '25': 2, '26': 2, '27': 2, '28': 2, '29': 2, '30': 2, '31': 2, '32': 4, '33': 2, '34': 2, '35': 2, '36': 4, '37': 4, '38': 2, '39': 2, '40': 4, '41': 2, '42': 2, '43': 2, '44': 2, '45': 8, '46': 2, '47': 4, '48': 4, '49': 2, '50': 2, '51': 2, '52': 2, '53': 2, '54': 2, '55': 2, '56': 8, '57': 2, '58': 8, '59': 2, '60': 4, '61': 2, '62': 2, '63': 2}, 
                             '3': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 2, '5': 2, '6': 4, '7': 2, '8': 4, '9': 4, '10': 4, '11': 2, '12': 2, '13': 2, '14': 2, '15': 8, '16': 2, '17': 2, '18': 2, '19': 2, '20': 2, '21': 2, '22': 4, '23': 2, '24': 2, '25': 2, '26': 2, '27': 2, '28': 2, '29': 2, '30': 2, '31': 8, '32': 2, '33': 4, '34': 4, '35': 2, '36': 2, '37': 2, '38': 2, '39': 4, '40': 2, '41': 2, '42': 2, '43': 4, '44': 2, '45': 2, '46': 2, '47': 4, '48': 2, '49': 2, '50': 2, '51': 2, '52': 2, '53': 2, '54': 2, '55': 4, '56': 2, '57': 2, '58': 2, '59': 4, '60': 4, '61': 4, '62': 2, '63': 2}, 
                             '4': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 2, '5': 2, '6': 8, '7': 2, '8': 2, '9': 4, '10': 2, '11': 2, '12': 2, '13': 2, '14': 2, '15': 2, '16': 2, '17': 2, '18': 2, '19': 4, '20': 4, '21': 8, '22': 2, '23': 2, '24': 2, '25': 4, '26': 2, '27': 2, '28': 4, '29': 4, '30': 2, '31': 2, '32': 2, '33': 8, '34': 4, '35': 8, '36': 2, '37': 4, '38': 2, '39': 2, '40': 2, '41': 2, '42': 2, '43': 4, '44': 2, '45': 4, '46': 2, '47': 2, '48': 2, '49': 2, '50': 4, '51': 2, '52': 2, '53': 2, '54': 2, '55': 2, '56': 2, '57': 2, '58': 2, '59': 2, '60': 2, '61': 2, '62': 8, '63': 4}, 
                             '5': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 2, '5': 2, '6': 4, '7': 2, '8': 8, '9': 2, '10': 4, '11': 4, '12': 2, '13': 2, '14': 8, '15': 4, '16': 4, '17': 4, '18': 2, '19': 2, '20': 8, '21': 4, '22': 2, '23': 4, '24': 2, '25': 2, '26': 2, '27': 4, '28': 4, '29': 2, '30': 2, '31': 4, '32': 2, '33': 2, '34': 2, '35': 4, '36': 2, '37': 8, '38': 4, '39': 4, '40': 2, '41': 2, '42': 2, '43': 4, '44': 4, '45': 4, '46': 2, '47': 2, '48': 2, '49': 2, '50': 2, '51': 4, '52': 2, '53': 8, '54': 2, '55': 8, '56': 4, '57': 2, '58': 2, '59': 8, '60': 4, '61': 4, '62': 4, '63': 2}, 
                             '6': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 2, '5': 2, '6': 2, '7': 2, '8': 8, '9': 4, '10': 2, '11': 2, '12': 2, '13': 2, '14': 2, '15': 2, '16': 8, '17': 2, '18': 8, '19': 2, '20': 2, '21': 4, '22': 2, '23': 2, '24': 4, '25': 2, '26': 2, '27': 2, '28': 2, '29': 2, '30': 2, '31': 2, '32': 4, '33': 2, '34': 2, '35': 2, '36': 4, '37': 2, '38': 2, '39': 2, '40': 4, '41': 2, '42': 2, '43': 2, '44': 4, '45': 2, '46': 2, '47': 4, '48': 8, '49': 4, '50': 2, '51': 2, '52': 2, '53': 2, '54': 2, '55': 2, '56': 2, '57': 4, '58': 4, '59': 2, '60': 2, '61': 2, '62': 2, '63': 2}, 
                             '7': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 8, '5': 4, '6': 2, '7': 2, '8': 2, '9': 2, '10': 2, '11': 2, '12': 2, '13': 4, '14': 2, '15': 2, '16': 4, '17': 2, '18': 2, '19': 2, '20': 2, '21': 4, '22': 2, '23': 2, '24': 2, '25': 2, '26': 8, '27': 2, '28': 2, '29': 2, '30': 2, '31': 2, '32': 4, '33': 4, '34': 2, '35': 8, '36': 2, '37': 2, '38': 2, '39': 2, '40': 2, '41': 2, '42': 2, '43': 2, '44': 2, '45': 4, '46': 8, '47': 2, '48': 2, '49': 2, '50': 2, '51': 2, '52': 2, '53': 2, '54': 2, '55': 4, '56': 2, '57': 2, '58': 2, '59': 2, '60': 2, '61': 2, '62': 2, '63': 8},
                             '8': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 2, '5': 2, '6': 2, '7': 4, '8': 2, '9': 2, '10': 2, '11': 2, '12': 8, '13': 2, '14': 2, '15': 2, '16': 4, '17': 2, '18': 2, '19': 2, '20': 8, '21': 2, '22': 4, '23': 2, '24': 4, '25': 4, '26': 2, '27': 8, '28': 2, '29': 4, '30': 2, '31': 2, '32': 4, '33': 4, '34': 4, '35': 2, '36': 2, '37': 8, '38': 2, '39': 2, '40': 2, '41': 2, '42': 2, '43': 2, '44': 2, '45': 8, '46': 2, '47': 2, '48': 4, '49': 2, '50': 2, '51': 4, '52': 4, '53': 2, '54': 4, '55': 8, '56': 8, '57': 4, '58': 2, '59': 2, '60': 4, '61': 2, '62': 4, '63': 4},
                             '9': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 2, '5': 4, '6': 4, '7': 8, '8': 4, '9': 4, '10': 2, '11': 4, '12': 4, '13': 2, '14': 2, '15': 2, '16': 2, '17': 4, '18': 2, '19': 2, '20': 4, '21': 2, '22': 2, '23': 2, '24': 2, '25': 2, '26': 8, '27': 4, '28': 4, '29': 2, '30': 2, '31': 2, '32': 2, '33': 2, '34': 4, '35': 8, '36': 2, '37': 4, '38': 2, '39': 2, '40': 4, '41': 8, '42': 4, '43': 2, '44': 2, '45': 2, '46': 2, '47': 2, '48': 8, '49': 2, '50': 4, '51': 4, '52': 2, '53': 2, '54': 2, '55': 4, '56': 2, '57': 2, '58': 2, '59': 2, '60': 2, '61': 2, '62': 2, '63': 4}, 
                            '10': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 4, '5': 4, '6': 4, '7': 2, '8': 2, '9': 8, '10': 2, '11': 2, '12': 2, '13': 4, '14': 2, '15': 2, '16': 2, '17': 8, '18': 4, '19': 2, '20': 4, '21': 2, '22': 2, '23': 8, '24': 4, '25': 2, '26': 2, '27': 2, '28': 8, '29': 8, '30': 2, '31': 4, '32': 4, '33': 2, '34': 4, '35': 2, '36': 2, '37': 8, '38': 2, '39': 2, '40': 2, '41': 8, '42': 2, '43': 4, '44': 4, '45': 2, '46': 4, '47': 2, '48': 4, '49': 2, '50': 2, '51': 2, '52': 2, '53': 2, '54': 2, '55': 4, '56': 2, '57': 4, '58': 2, '59': 4, '60': 2, '61': 2, '62': 2, '63': 2}, 
                            '11': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 2, '5': 2, '6': 2, '7': 2, '8': 2, '9': 4, '10': 2, '11': 2, '12': 4, '13': 2, '14': 8, '15': 4, '16': 2, '17': 4, '18': 2, '19': 2, '20': 4, '21': 2, '22': 2, '23': 2, '24': 2, '25': 4, '26': 2, '27': 2, '28': 4, '29': 4, '30': 2, '31': 2, '32': 2, '33': 4, '34': 2, '35': 2, '36': 2, '37': 4, '38': 2, '39': 2, '40': 2, '41': 4, '42': 2, '43': 2, '44': 2, '45': 2, '46': 4, '47': 4, '48': 2, '49': 4, '50': 2, '51': 4, '52': 2, '53': 2, '54': 4, '55': 2, '56': 2, '57': 4, '58': 4, '59': 2, '60': 2, '61': 2, '62': 4, '63': 2}, 
                            '12': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 2, '5': 2, '6': 4, '7': 2, '8': 4, '9': 2, '10': 8, '11': 8, '12': 4, '13': 2, '14': 2, '15': 2, '16': 2, '17': 4, '18': 2, '19': 2, '20': 4, '21': 2, '22': 2, '23': 4, '24': 8, '25': 4, '26': 8, '27': 2, '28': 2, '29': 8, '30': 4, '31': 4, '32': 2, '33': 2, '34': 2, '35': 4, '36': 2, '37': 2, '38': 2, '39': 2, '40': 2, '41': 4, '42': 4, '43': 2, '44': 2, '45': 2, '46': 2, '47': 2, '48': 8, '49': 2, '50': 4, '51': 2, '52': 2, '53': 8, '54': 4, '55': 4, '56': 4, '57': 4, '58': 4, '59': 4, '60': 4, '61': 2, '62': 2, '63': 2}, 
                            '13': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 4, '5': 4, '6': 2, '7': 4, '8': 2, '9': 4, '10': 8, '11': 2, '12': 2, '13': 2, '14': 2, '15': 2, '16': 2, '17': 4, '18': 8, '19': 8, '20': 2, '21': 2, '22': 4, '23': 4, '24': 2, '25': 8, '26': 2, '27': 4, '28': 8, '29': 4, '30': 2, '31': 8, '32': 8, '33': 2, '34': 2, '35': 2, '36': 8, '37': 2, '38': 2, '39': 4, '40': 2, '41': 2, '42': 2, '43': 4, '44': 2, '45': 2, '46': 2, '47': 2, '48': 2, '49': 2, '50': 2, '51': 4, '52': 2, '53': 4, '54': 2, '55': 4, '56': 2, '57': 4, '58': 2, '59': 8, '60': 4, '61': 4, '62': 8, '63': 8}, 
                            '14': {'0': 8, '1': 2, '2': 4, '3': 2, '4': 2, '5': 2, '6': 2, '7': 8, '8': 4, '9': 4, '10': 2, '11': 2, '12': 4, '13': 4, '14': 2, '15': 4, '16': 2, '17': 2, '18': 2, '19': 8, '20': 2, '21': 2, '22': 4, '23': 2, '24': 2, '25': 2, '26': 4, '27': 4, '28': 2, '29': 4, '30': 2, '31': 2, '32': 2, '33': 2, '34': 2, '35': 2, '36': 2, '37': 2, '38': 2, '39': 8, '40': 4, '41': 2, '42': 2, '43': 2, '44': 2, '45': 2, '46': 8, '47': 8, '48': 2, '49': 4, '50': 2, '51': 2, '52': 8, '53': 2, '54': 2, '55': 2, '56': 2, '57': 8, '58': 4, '59': 4, '60': 2, '61': 4, '62': 8, '63': 2}, 
                            '15': {'0': 8, '1': 2, '2': 4, '3': 4, '4': 2, '5': 2, '6': 8, '7': 2, '8': 2, '9': 4, '10': 2, '11': 2, '12': 2, '13': 2, '14': 2, '15': 2, '16': 2, '17': 4, '18': 2, '19': 2, '20': 2, '21': 2, '22': 4, '23': 8, '24': 8, '25': 2, '26': 4, '27': 4, '28': 2, '29': 4, '30': 2, '31': 8, '32': 2, '33': 2, '34': 2, '35': 8, '36': 8, '37': 2, '38': 2, '39': 4, '40': 2, '41': 4, '42': 2, '43': 8, '44': 2, '45': 4, '46': 2, '47': 2, '48': 2, '49': 2, '50': 2, '51': 2, '52': 4, '53': 8, '54': 2, '55': 2, '56': 2, '57': 8, '58': 2, '59': 2, '60': 4, '61': 2, '62': 2, '63': 2}}
    my_list = [2, 4, 8]
    plot_metric_heatmap_deepseek(layer_dict, my_list, "quantized_experts.pdf")
    print("Heatmap saved to quantized_experts.pdf")


